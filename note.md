# 6.5 프락시 요청의 미묘한 특징들

### 6.5.1 프락시 URL 는 서버 URL 와 다르다
<details>
    <summary>내용</summary>

#### 클라 ->  서버 직접 요청
* ![img_6.png](img_6.png)
* URL 부분에 주목! -> '/index.html' 과 같이 부분 URL 만 표시
#### 클라 -> 프락시 -> 서버 요청
* ![img_7.png](img_7.png)
* 프락시로 요청을 보낼 때, 완전한 URL 을 보냄

#### 왜 원 서버로 보낼 때와 프락시로 보낼 때 URL 이 다를까? -> HTTP 역사와 디펜던시가 있는 부분
* 과거 상황
    * 원래의 HTTP 설계에서, 클라는 단일한 서버와 통신하는 것이 전재되어 있었다.
        * 가상 호스팅, 프락시에 대한 대비가 없었다.
    * 단일 서버와 통신을 가정한다면, 해당 서버의 호스트 명과 포트번호는 불필요한 정보였다.
        * 따라서 보내지 않았던 것이다.
* 현 상황
    * 프락시, 가상호스팅 등이 부상했다.
    * 이에 따라 부분 URL 만 보내는 것이 문제가 되었다.
        * ex> [클라 <-> 프락시 <-> 원 서버] 상황에서 [클라 -> 프락시]로 부분 URL 만 보내면 프락시 입장에선 어느 서버로 요청을 전달할 지 알 수 없었다.
* HTTP 1.0 에서의 해결책
    * 프락시 요청의 경우 완전한 URL 을 요구하는 것으로 문제를 해결???
        * 해결이라기 보단 프락시가 부상하면서 급한 불을 끈 느낌
* HTTP 1.1 에서의 해결책
    * 프락시건 뭐건 클라는 완전한 URL 을 다룰 것을 요구
    * but HTTP 1.0 시절의 스팩으로 이미 배치된 서버가 너무 많고 이 서버들은 완전한 URL 을 받아들이지 못하는 경우가 많다ㅠㅠ

#### 따라서 일반적으로 서버로는 부분 URL 을, 프락시로는 완전한 URL 을 보낼 필요가 있다.
* 우리는 HTTP 클라이언트를 사용하고 있고 이 클라이언트에게 프락시를 쓸지 말지 설정을 할 수 있다.
* HTTP 클라이언트는 프록시 사용 설정에 따라 똑똑하게 아래와 같이 동작한다.
    * 클라가 프록시를 사용하도록 설정된 경우 -> 완전한 URL 을 보낸다
    * 클라가 프록시를 사용하지 않도록 설정된 경우 -> 부분 URL 을 보낸다

#### Q) 리버스 프락시를 사용할 경우는 어떻게 될까?
* 리버스 프락시는 클라가 프록시를 사용하는지 조차 모르는 것이 특징이다.
* 따라서 클라 입장에선 명시적인 프락시 설정이 포함되지 않을 것이고
* 따라서 부분 URL 을 보낼 것 같다.
    * 즉, 리버스 프락시 구현 서버들은 부분 URL 에 대해 대비가 되어 있어야 할 것이다.
</details>

### 6.5.2 가상 호스팅에서 일어나는 같은 문제
<details>
    <summary>내용</summary>

#### 프락시의 부분 URL 문제는 가상 호스팅 되는 웹 서버가 직면한 것과 같은 문제다.
* 가상으로 호스팅 되는 웹 서버는 여러 웹 사이트가 같은 물리적 웹 서버를 공유
* 요청 하나가 부분 URL /index.html 로 도착하면 가상 호스팅 되는 웹 서버는 해당 URL 가 실제 어느 가상 웹 사이트의 호스트 명인지 알 필요가 있으나 알 방법이 없다.

#### 문제 상황은 비슷하지만 프락시와 가상 호스팅은 각기 다른 방식으로 문제를 풀었다.
* 프락시 
  * 위에서 언급한 대로 완전한 URL 을 갖도록 함
* 가상 호스팅
  * 호스트와 포트에 대한 정보가 담겨 있는 Host 헤더를 요구
</details>
    
### 6.5.3 리버스 프락시, 인터셉트 프락시는 부분 URL 을 받는다
* ![img_8.png](img_8.png)
* 클라 입장에서 프락시를 사용하는지 모르는 경우는 부분 URL 을 보낼 수 밖에 없고 리버스 프락시와 인터셉트 프락시는 이에 맞춰서 개발할 수 밖에 없을듯

### 6.5.4 프락시는 프락시 요청과 서버 요청을 모두 다룰 수 있다.
<details>
<summary>내용</summary>

* 다목적 프락시 서버는 요청 메시지의 완전한 URL 와 부분 URL 을 모두 지원해야 한다.
  * 명시적인 프락시 요청에 대해서는 완전한 URL 를 사용하고 
  * 아니면 부분 URL 을 사용해야 하며, 
  * 웹 서버 요청의 겅우에는 가상 Host 헤더를 사용해야 한다.

#### 다목적 프락시 서버가 원 서버를 알아내는 방법
1. 완전한 URL 이 주어졌다면, 프락시는 그것을 사용해야 한다.
2. 부분 URL 가 주어졌고 Host 헤더가 있다면, Host 헤더를 이용해 원 서버의 이름과 포트를 알아내야 한다.
3. 부분 URL 가 주어졌으나 Host 헤더가 없다면, 다음의 방법으로 원 서버를 알아내야 한다.
   * 프락시가 원 서버를 대신하는 대리 프락시라면, 프락시에 실제 서버의 주소와 포트 번호가 설정되어 있을 수 있다.
   * (?)이전에 어떤 인터셉ㅇ트 프락시가 가로챘던 트래픽을 받았고, 그 인터셉트 프락시가 원 IP 주소와 포트번호를 사용할 수 있도록 해 두었다면, 그 IP 주소와 포트번호를 사용할 수 있다.
   * 모두 실패했다면, 프락시는 원 서버를 알아낼 수 있는 충분한 정보가 없다고 판단해야 한다.
     * 반드시 에러 메시지(보통 사용자에게 Host 헤더를 지원하는 현대적인 웹브라우저로 업그레이드 하라는 것) 를 반환해야 한다.
</details>






